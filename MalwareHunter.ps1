#Requires -RunAsAdministrator
<#
.SYNOPSIS
    CyberPatriot - Enhanced Malware Hunter
.DESCRIPTION
    Comprehensive malware detection and removal tool for CyberPatriot.
    Malware was a major issue last season - this script helps find and remove it.
.NOTES
    Run as Administrator
    Use this AFTER completing forensics questions!
#>

Add-Type -AssemblyName System.Windows.Forms

$LogFile = "MalwareHunt-$(Get-Date -Format 'yyyyMMdd-HHmmss').txt"

function Write-MalwareLog {
    param([string]$Message, [string]$Type = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Type] $Message"
    Add-Content -Path $LogFile -Value $logMessage
    Write-Host $logMessage -ForegroundColor $(
        switch ($Type) {
            "ERROR" { "Red" }
            "WARNING" { "Yellow" }
            "SUCCESS" { "Green" }
            "CRITICAL" { "Magenta" }
            default { "White" }
        }
    )
}

function Update-DefenderSignatures {
    Write-MalwareLog "Updating Windows Defender malware definitions..." "INFO"
    try {
        Update-MpSignature
        Write-MalwareLog "Malware definitions updated successfully!" "SUCCESS"
        $status = Get-MpComputerStatus
        Write-MalwareLog "Signature version: $($status.AntivirusSignatureVersion)" "INFO"
        Write-MalwareLog "Last updated: $($status.AntivirusSignatureLastUpdated)" "INFO"
        return $true
    } catch {
        Write-MalwareLog "Failed to update definitions: $_" "ERROR"
        return $false
    }
}

function Start-ComprehensiveScan {
    param([string]$ScanType = "Quick")
    
    Write-MalwareLog "Starting $ScanType scan..." "INFO"
    
    if ($ScanType -eq "Full") {
        Write-MalwareLog "WARNING: Full scan can take 30-60 minutes!" "WARNING"
        Write-MalwareLog "The scan will run in the background." "INFO"
    }
    
    try {
        $scanTypeEnum = if ($ScanType -eq "Full") { "FullScan" } else { "QuickScan" }
        Start-MpScan -ScanType $scanTypeEnum -AsJob | Out-Null
        Write-MalwareLog "$ScanType scan started successfully (running in background)" "SUCCESS"
        Write-MalwareLog "Check Windows Security for scan results" "INFO"
        return $true
    } catch {
        Write-MalwareLog "Failed to start scan: $_" "ERROR"
        return $false
    }
}

function Find-MaliciousProcesses {
    Write-MalwareLog "Scanning for suspicious processes..." "INFO"
    
    $suspiciousPatterns = @(
        "*keylog*", "*trojan*", "*rat*", "*backdoor*",
        "*miner*", "*cryptolock*", "*ransom*",
        "*torrent*", "*bittorrent*",
        "*wireshark*", "*nmap*", "*netcat*",
        "*vnc*", "*teamviewer*", "*anydesk*"
    )
    
    $foundProcesses = @()
    $allProcesses = Get-Process
    
    foreach ($pattern in $suspiciousPatterns) {
        $matches = $allProcesses | Where-Object { 
            $_.ProcessName -like $pattern -or 
            ($_.Path -and $_.Path -like $pattern)
        }
        if ($matches) {
            $foundProcesses += $matches
        }
    }
    
    if ($foundProcesses.Count -gt 0) {
        Write-MalwareLog "Found $($foundProcesses.Count) suspicious processes:" "CRITICAL"
        foreach ($proc in $foundProcesses) {
            Write-MalwareLog "  PID $($proc.Id): $($proc.ProcessName)" "WARNING"
            if ($proc.Path) {
                Write-MalwareLog "    Path: $($proc.Path)" "WARNING"
            }
            Write-MalwareLog "    Started: $($proc.StartTime)" "INFO"
        }
        return $foundProcesses
    } else {
        Write-MalwareLog "No obviously suspicious processes found" "SUCCESS"
        return $null
    }
}

function Find-SuspiciousFiles {
    Write-MalwareLog "Scanning for suspicious files in common locations..." "INFO"
    
    $suspiciousLocations = @(
        @{Path = "$env:TEMP"; Name = "User Temp"},
        @{Path = "$env:USERPROFILE\AppData\Local\Temp"; Name = "AppData Temp"},
        @{Path = "$env:USERPROFILE\AppData\Roaming"; Name = "AppData Roaming"},
        @{Path = "$env:USERPROFILE\Downloads"; Name = "Downloads"},
        @{Path = "C:\Windows\Temp"; Name = "Windows Temp"},
        @{Path = "$env:USERPROFILE\Desktop"; Name = "Desktop"}
    )
    
    # Files modified in last 7 days with suspicious extensions
    $suspiciousExtensions = @("*.vbs", "*.bat", "*.cmd", "*.ps1", "*.exe", "*.scr", "*.com", "*.pif", "*.jar")
    $allSuspiciousFiles = @()
    
    foreach ($location in $suspiciousLocations) {
        if (-not (Test-Path $location.Path)) { continue }
        
        Write-MalwareLog "Scanning: $($location.Name)..." "INFO"
        
        foreach ($ext in $suspiciousExtensions) {
            try {
                $files = Get-ChildItem -Path $location.Path -Filter $ext -Recurse -ErrorAction SilentlyContinue -File |
                         Where-Object { 
                             $_.LastWriteTime -gt (Get-Date).AddDays(-30) -and
                             # Exclude known safe files
                             $_.FullName -notlike "*Windows\System32*" -and
                             $_.FullName -notlike "*Program Files*" -and
                             $_.FullName -notlike "*Microsoft*" -and
                             # Exclude forensics/competition files
                             $_.FullName -notlike "*CyberPatriot*" -and
                             $_.FullName -notlike "*Forensic*"
                         }
                
                if ($files) {
                    $allSuspiciousFiles += $files
                    foreach ($file in $files) {
                        Write-MalwareLog "  SUSPICIOUS: $($file.FullName)" "WARNING"
                        Write-MalwareLog "    Size: $([math]::Round($file.Length/1KB, 2)) KB | Modified: $($file.LastWriteTime)" "INFO"
                    }
                }
            } catch {
                # Ignore access denied
            }
        }
    }
    
    if ($allSuspiciousFiles.Count -gt 0) {
        Write-MalwareLog "Found $($allSuspiciousFiles.Count) suspicious files!" "CRITICAL"
    } else {
        Write-MalwareLog "No suspicious files found in scanned locations" "SUCCESS"
    }
    
    return $allSuspiciousFiles
}

function Find-SuspiciousScheduledTasks {
    Write-MalwareLog "Checking for suspicious scheduled tasks..." "INFO"
    
    try {
        $tasks = Get-ScheduledTask | Where-Object { 
            $_.State -ne "Disabled" -and
            $_.TaskPath -notlike "*\Microsoft\*"
        }
        
        $suspiciousTasks = @()
        
        foreach ($task in $tasks) {
            $taskInfo = Get-ScheduledTaskInfo -TaskName $task.TaskName -TaskPath $task.TaskPath -ErrorAction SilentlyContinue
            
            # Check if task runs scripts or executables from temp/suspicious locations
            $actions = $task.Actions | Where-Object {
                $_.Execute -like "*.vbs" -or
                $_.Execute -like "*.bat" -or
                $_.Execute -like "*.ps1" -or
                ($_.Execute -like "*.exe" -and (
                    $_.Execute -like "*\Temp\*" -or
                    $_.Execute -like "*\AppData\*" -or
                    $_.Execute -like "*\Downloads\*"
                ))
            }
            
            if ($actions) {
                $suspiciousTasks += $task
                Write-MalwareLog "  SUSPICIOUS TASK: $($task.TaskName)" "WARNING"
                Write-MalwareLog "    Path: $($task.TaskPath)" "INFO"
                Write-MalwareLog "    State: $($task.State)" "INFO"
                foreach ($action in $actions) {
                    Write-MalwareLog "    Executes: $($action.Execute) $($action.Arguments)" "WARNING"
                }
            }
        }
        
        if ($suspiciousTasks.Count -gt 0) {
            Write-MalwareLog "Found $($suspiciousTasks.Count) suspicious scheduled tasks!" "CRITICAL"
        } else {
            Write-MalwareLog "No suspicious scheduled tasks found" "SUCCESS"
        }
        
        return $suspiciousTasks
    } catch {
        Write-MalwareLog "Error checking scheduled tasks: $_" "ERROR"
        return $null
    }
}

function Find-SuspiciousStartupItems {
    Write-MalwareLog "Checking startup locations for malware..." "INFO"
    
    $startupLocations = @(
        @{Path = "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run"; Name = "HKLM Run"},
        @{Path = "HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce"; Name = "HKLM RunOnce"},
        @{Path = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"; Name = "HKCU Run"},
        @{Path = "HKCU:\Software\Microsoft\Windows\CurrentVersion\RunOnce"; Name = "HKCU RunOnce"},
        @{Path = "$env:ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"; Name = "All Users Startup"; Type = "Folder"},
        @{Path = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup"; Name = "User Startup"; Type = "Folder"}
    )
    
    $suspiciousStartup = @()
    
    foreach ($location in $startupLocations) {
        Write-MalwareLog "Checking: $($location.Name)..." "INFO"
        
        if ($location.Type -eq "Folder") {
            if (Test-Path $location.Path) {
                $files = Get-ChildItem -Path $location.Path -File
                foreach ($file in $files) {
                    Write-MalwareLog "  Startup item: $($file.Name) -> $($file.FullName)" "WARNING"
                    $suspiciousStartup += [PSCustomObject]@{
                        Location = $location.Name
                        Name = $file.Name
                        Command = $file.FullName
                    }
                }
            }
        } else {
            try {
                $items = Get-ItemProperty -Path $location.Path -ErrorAction SilentlyContinue
                if ($items) {
                    $items.PSObject.Properties | Where-Object { $_.Name -notlike "PS*" } | ForEach-Object {
                        $suspicious = $false
                        
                        # Flag if running from suspicious locations
                        if ($_.Value -like "*\Temp\*" -or 
                            $_.Value -like "*\AppData\Roaming\*" -or
                            $_.Value -like "*\Downloads\*") {
                            $suspicious = $true
                        }
                        
                        $color = if ($suspicious) { "CRITICAL" } else { "WARNING" }
                        Write-MalwareLog "  $($_.Name) -> $($_.Value)" $color
                        
                        $suspiciousStartup += [PSCustomObject]@{
                            Location = $location.Name
                            Name = $_.Name
                            Command = $_.Value
                        }
                    }
                }
            } catch {
                # Registry key doesn't exist
            }
        }
    }
    
    if ($suspiciousStartup.Count -gt 0) {
        Write-MalwareLog "Found $($suspiciousStartup.Count) startup items to review!" "WARNING"
    } else {
        Write-MalwareLog "No startup items found (this might be unusual)" "INFO"
    }
    
    return $suspiciousStartup
}

function Check-HostsFile {
    Write-MalwareLog "Checking HOSTS file for malicious entries..." "INFO"
    
    $hostsPath = "$env:SystemRoot\System32\drivers\etc\hosts"
    
    if (Test-Path $hostsPath) {
        $hostsContent = Get-Content $hostsPath
        $suspiciousEntries = $hostsContent | Where-Object { 
            $_ -notlike "#*" -and 
            $_ -notlike "" -and
            $_ -notlike "*localhost*" -and
            $_ -notlike "*::1*"
        }
        
        if ($suspiciousEntries) {
            Write-MalwareLog "Found $($suspiciousEntries.Count) non-standard HOSTS entries:" "WARNING"
            foreach ($entry in $suspiciousEntries) {
                Write-MalwareLog "  $entry" "WARNING"
            }
            return $suspiciousEntries
        } else {
            Write-MalwareLog "HOSTS file appears clean" "SUCCESS"
            return $null
        }
    } else {
        Write-MalwareLog "HOSTS file not found (unusual)" "WARNING"
        return $null
    }
}

function Get-MalwareStatus {
    Write-MalwareLog "Getting Windows Defender status..." "INFO"
    
    try {
        $status = Get-MpComputerStatus
        
        Write-MalwareLog "Windows Defender Status:" "INFO"
        Write-MalwareLog "  Real-time Protection: $($status.RealTimeProtectionEnabled)" "INFO"
        Write-MalwareLog "  Antivirus Enabled: $($status.AntivirusEnabled)" "INFO"
        Write-MalwareLog "  Signature Version: $($status.AntivirusSignatureVersion)" "INFO"
        Write-MalwareLog "  Last Quick Scan: $($status.QuickScanEndTime)" "INFO"
        Write-MalwareLog "  Last Full Scan: $($status.FullScanEndTime)" "INFO"
        
        # Check for threats
        $threats = Get-MpThreat
        if ($threats) {
            Write-MalwareLog "ACTIVE THREATS DETECTED: $($threats.Count)" "CRITICAL"
            foreach ($threat in $threats) {
                Write-MalwareLog "  Threat: $($threat.ThreatName)" "CRITICAL"
                Write-MalwareLog "    Severity: $($threat.SeverityID)" "CRITICAL"
                Write-MalwareLog "    Resources: $($threat.Resources -join ', ')" "INFO"
            }
        } else {
            Write-MalwareLog "No active threats detected by Windows Defender" "SUCCESS"
        }
        
        return $status
    } catch {
        Write-MalwareLog "Failed to get Defender status: $_" "ERROR"
        return $null
    }
}

# Main Execution
Write-MalwareLog "========================================" "INFO"
Write-MalwareLog "CyberPatriot Enhanced Malware Hunter" "INFO"
Write-MalwareLog "Malware was a BIG problem last season!" "CRITICAL"
Write-MalwareLog "========================================" "INFO"
Write-MalwareLog "" "INFO"

# Step 1: Update definitions
Write-MalwareLog "STEP 1: Updating malware definitions..." "INFO"
Update-DefenderSignatures
Write-MalwareLog "" "INFO"

# Step 2: Check Defender status
Write-MalwareLog "STEP 2: Checking Windows Defender status..." "INFO"
Get-MalwareStatus
Write-MalwareLog "" "INFO"

# Step 3: Find suspicious processes
Write-MalwareLog "STEP 3: Scanning for malicious processes..." "INFO"
$suspiciousProcs = Find-MaliciousProcesses
Write-MalwareLog "" "INFO"

# Step 4: Find suspicious files
Write-MalwareLog "STEP 4: Scanning for suspicious files..." "INFO"
$suspiciousFiles = Find-SuspiciousFiles
Write-MalwareLog "" "INFO"

# Step 5: Check startup items
Write-MalwareLog "STEP 5: Checking startup locations..." "INFO"
$suspiciousStartup = Find-SuspiciousStartupItems
Write-MalwareLog "" "INFO"

# Step 6: Check scheduled tasks
Write-MalwareLog "STEP 6: Checking scheduled tasks..." "INFO"
$suspiciousTasks = Find-SuspiciousScheduledTasks
Write-MalwareLog "" "INFO"

# Step 7: Check HOSTS file
Write-MalwareLog "STEP 7: Checking HOSTS file..." "INFO"
$hostsIssues = Check-HostsFile
Write-MalwareLog "" "INFO"

# Summary
Write-MalwareLog "========================================" "INFO"
Write-MalwareLog "MALWARE SCAN COMPLETE" "INFO"
Write-MalwareLog "========================================" "INFO"

$issueCount = 0
if ($suspiciousProcs) { $issueCount += $suspiciousProcs.Count }
if ($suspiciousFiles) { $issueCount += $suspiciousFiles.Count }
if ($suspiciousTasks) { $issueCount += $suspiciousTasks.Count }

if ($issueCount -gt 0) {
    Write-MalwareLog "FOUND $issueCount POTENTIAL ISSUES!" "CRITICAL"
    Write-MalwareLog "Review the log file and investigate each item!" "WARNING"
} else {
    Write-MalwareLog "No obvious malware found in quick scan" "SUCCESS"
    Write-MalwareLog "Consider running a FULL Windows Defender scan for thoroughness" "INFO"
}

Write-MalwareLog "" "INFO"
Write-MalwareLog "Log file saved to: $LogFile" "INFO"
Write-MalwareLog "" "INFO"
Write-MalwareLog "NEXT STEPS:" "INFO"
Write-MalwareLog "1. Review this log file carefully" "INFO"
Write-MalwareLog "2. Run a FULL Windows Defender scan (Win+R > windowsdefender:)" "INFO"
Write-MalwareLog "3. Consider running MRT (Win+R > mrt)" "INFO"
Write-MalwareLog "4. Delete any confirmed malicious files" "INFO"
Write-MalwareLog "5. Terminate any malicious processes" "INFO"
Write-MalwareLog "" "INFO"

# Ask if user wants to run full scan now
$response = Read-Host "Do you want to start a FULL Windows Defender scan now? (This takes 30+ minutes) [y/N]"
if ($response -eq 'y' -or $response -eq 'Y') {
    Start-ComprehensiveScan -ScanType "Full"
}

# Open log file
Start-Process notepad.exe -ArgumentList $LogFile

Write-Host "`nPress any key to exit..."
$null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
